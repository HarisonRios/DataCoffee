<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DataCoffee</title>
    <link rel="shortcut icon" href="../../assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
    <h1 id="titulo"> <br>
      Plantação de Café</h1>
  
  
    <div id="container" class="container">
      
    </div>
    

    
  <div id="nav-bar"> 
    <input id="nav-toggle" type="checkbox" />
    <div id="nav-header"><a id="nav-title" onclick="home()" target="_blank"><img src="../../assets/img/logoSemFundo.png" alt="Logo DataCoffee"></a>
      <label for="nav-toggle"><span id="nav-toggle-burger"></span></label>
    </div>


    <div id="nav-content">
        <div onclick="home()" class="nav-button"><i class="fas fa-home"></i><span>Home</span></div>
        
        

      <div id="nav-content-highlight"></div>
    </div>

    <input id="nav-footer-toggle" type="checkbox" />

    <div id="nav-footer">
      <div id="nav-footer-heading">
        <div id="nav-footer-avatar"><img src="../assets/img/icon.png" /></div>
        <div id="nav-footer-titlebox"><p id="b_usuario">usuário</p><span id="nav-footer-subtitle">Administrador</span></div>
        <label for="nav-footer-toggle"><i class="fas fa-caret-up"></i></label>
      </div>


      <div id="nav-footer-content">
          <div class="nav-button"><i class="fas fa-user-circle"></i><span>Perfil</span></div>
        <div class="nav-button"><i class="fas fa-user-plus"></i><span>Logar com outro Usuário</span></div>
        <div onclick="limparSessao()" class="nav-button"><i class="fas fa-sign-out-alt"></i><span >Sair</span></div>
      </div>
    </div>
  </div>
</body>

</html>
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css'>


<script>


  // para mudar a cor da plantação tem que pegar os dados da KPI dela
function obterDadosGrafico(idPlantacao) {

fetch(`/medidas/buscarRegistros/${idPlantacao}`, { cache: 'no-store' }).then(function (response) {
  if (response.ok) {
    response.json().then(function (resposta) {
      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
      console.log(resposta.temp[0]['registro'])
      corPlantacao(resposta, idPlantacao)
    });
  } else {
    console.error('Nenhum dado encontrado ou erro na API');
  }
})
  .catch(function (error) {
    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
  });

}

function corPlantacao(registros, idPlantacao){
  // separando a resposta
  let registrosTemp = registros.temp
  let registrosUmi = registros.umi
  let idCard = 'card'+ idPlantacao
// pegando os ultimos registros
  let kpiTempAtual = registrosTemp[0].registro
  let kpiUmiAtual = registrosUmi[0].registro

  if(kpiTempAtual <= 20 || kpiTempAtual > 25 || kpiUmiAtual <= 60 || kpiUmiAtual > 80){
    var  plantacaoCard = document.getElementById(idCard);
    plantacaoCard.className = 'plantacao nao-funcionando';
  }

}



  var Plantacoes  = sessionStorage.PLANTACOES;
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;


        // Exibe o valor de Plantacao no <h1> após a página carregar
        window.onload = function() {
          var plantacoesArray = JSON.parse(Plantacoes);
            const titulo = document.getElementById("titulo");
            titulo.innerHTML = `${plantacoesArray[0].razao_social} <br>Plantação de Café`;
        };
console.log(sessionStorage.PLANTACOES);

if (sessionStorage.PLANTACOES) {
    JSON.parse(sessionStorage.PLANTACOES).forEach(item => {
        document.getElementById("container").innerHTML += `
            <div class="plantacao-container">
                <div id="card${item.idPlantacao}" onclick="dashboard(${item.idPlantacao})" class="plantacao funcionando">
                    <i class="fas fa-seedling"></i>
                    <span>Plantacao ${item.idPlantacao}</span>
                    Sensor Instalado<br> <strong></strong>
                </div>
            </div>`;

          obterDadosGrafico(item.idPlantacao)



    });
} else {
    console.warn("Nenhuma plantação encontrada no sessionStorage.");
}






function limparSessao() {
    // Limpa todos os dados da sessionStorage
    sessionStorage.clear();

    // Redireciona para a página de logout ou a página de destino
    window.location = "../index.html";
};


    function dashboard(idPlantacao){


        window.location.href = "./indexD.html"
    }

    function home(){
            window.location.href = "../index.html"
    }
</script>
<script src="../js/sessao.js"></script>cr