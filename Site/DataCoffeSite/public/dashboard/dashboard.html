<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../style.css">
    <title>Dashboard - DataCoffee </title>
</head>
<body>
    <div class="conteiner-main">
        <div id="nav-bar">
            <input id="nav-toggle" type="checkbox" />
            <div id="nav-header"><a id="nav-title" href="../frontend/index.html" target="_blank"><img
                        src="../assets/img/logoSemFundo.png" alt="Logo DataCoffee"></a>
                <label for="nav-toggle"><span id="nav-toggle-burger"></span></label>
            </div>
    
    
            <div id="nav-content">
                <div onclick="home()" class="nav-button"><i data-feather="home"></i><span><a
                            href="../index.html">Home</a></span></div>
                <div onclick="plantacao()" class="nav-button"><i class="fas fa-seedling"></i><span>Plantações</span></div>
                <div onclick="grafico()" class="nav-button"><i class="fas fa-chart-bar"></i><span>Avisos</span></div>
    
    
    
                <div id="nav-content-highlight"></div>
            </div>
    
            <input id="nav-footer-toggle" type="checkbox" />
    
            <div id="nav-footer">
                <div id="nav-footer-heading">
                    <div id="nav-footer-avatar"></div>
                    <div id="nav-footer-titlebox">DataCoffee<span id="nav-footer-subtitle">Administrador</span></div>
                    <label for="nav-footer-toggle"><i class="fas fa-caret-up"></i></label>
                </div>
    
    
                <div id="nav-footer-content">
                    <div class="nav-button"><i class="fas fa-user-circle"></i><span>Perfil</span></div>
                    <div class="nav-button"><i class="fas fa-user-plus"></i><span>Logar com outro Usuário</span></div>
                    <div class="nav-button"><i class="fas fa-sign-out-alt"></i><span>Sair</span></div>
                </div>
            </div>
        </div>
         



        <section class="content-dash">
            <div class="container">
                <div class="area-parametros-alerta">
                    <p class="titulo-legenda">
                        Parâmetros para Alertas - Temperatura e Umidade do Solo
                    </p>
                    <div class="parametros-alerta">
                        <div class="item-regua abaixo">
                            <strong>Abaixo</strong>
                            <span> 20 Cº <i class="fas fa-temperature-low"></i></span>
                            <span> 60 % <i class="fas fa-tint"></i> </span>
                        </div>
                        <div class="item-regua ideal">
                            <strong>Ideal</strong>
                            <span> 23 Cº <i class="fas fa-temperature-low"></i></span>
                            <span> 70 % <i class="fas fa-tint"></i></span>
                        </div>
                        <div class="item-regua acima">
                            <strong>Acima</strong>
                            <span> 25 Cº <i class="fas fa-temperature-low"></i></span>
                            <span> 80 % <i class="fas fa-tint"></i></span>
                        </div>
                    </div>
                </div>
                <div class="kpi-container">
                    <!-- Temperatura Atual -->
                    <div class="kpi atual_acima" id="temperaturaAtual">
                        <i class="fas fa-temperature-high"></i>
                        <div class="kpi_legenda">
                            <h3>Temperatura Atual</h3>
                        </div>
                        <div>
                            <span id="kpi_temp">15°</span>
                        </div>
                    </div>

                    <!-- Tempo fora da condição ideal (Temperatura) -->
                    <div class="kpi" id="foraTemperatura">
                        <i class="fas fa-cloud-sun"></i>
                        <div class="kpi_legenda">
                            <h3>Tempo fora da condição ideal (Dia)</h3>
                        </div>
                        <div>
                            <span>10H</span>
                        </div>
                    </div>

                    <!-- Umidade Atual -->
                    <div class="kpi atual_acima" id="umidadeAtual">
                        <i class="fas fa-tint"></i>
                        <div class="kpi_legenda">
                            <h3>Umidade Atual</h3>
                        </div>
                        <div><span id="kpi_umi">50%</span></div>
                    </div>

                    <!-- Tempo fora da condição ideal (Umidade) -->
                    <div class="kpi" id="foraUmidade">
                        <i class="fas fa-cloud-rain"></i>
                        <div class="kpi_legenda">
                            <h3>Tempo fora da condição ideal (Dia)</h3>
                        </div>
                        <div><span>3H</span></div>
                    </div>
                </div>


                <div class="chart-container">
                    <div class="grafico-temperatura-umidade">
                        <h2>Gráfico de Temperatura</h2>
                        <canvas id="graficoTemperatura"></canvas>
                    </div>
                    <div class="grafico-temperatura-umidade">
                        <h2>Gráfico de Umidade</h2>
                        <canvas id="graficoUmidade"></canvas>
                    </div>
                </div>

        </section>

    </div>
</body>
</html>


<script>
function obterDadosGrafico(){
    fetch(`/medidas/buscarRegistros/`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    console.log(resposta.temp[0]['registro'])
                    gerarGrafico(resposta)

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    
}

function gerarGrafico(resposta) {
    
    let dados = {
            labels: [],
            datasets: [
                {
                    label: 'Temperatura (°C)',
                    data: [],
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: true,
                },
                {
                    label: 'Umidade (%)',
                    data: [],
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: true,
                },
                 ]
        };

        var kpiTempAtual = 0
        var kpiUmiAtual = 0 
    // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (let i = 0; i < resposta.temp.length; i++) {
    
       
        let registrosTemp = resposta.temp
    

        let registrosUmi = resposta.umi
        console.log(registrosTemp[i].dtRegistro)

        dados.labels.push(registrosTemp[i].dtRegistro); 
        
        dados.datasets[0].data.push(registrosTemp[i].registro);  
        
        dados.datasets[1].data.push(registrosUmi[i].registro);  

        // inserção de kpi de atual
        if(i == 0){
            kpiTempAtual = registrosTemp[i].registro
            kpiUmiAtual = registrosUmi[i].registro
            kpi_temp.innerHTML = kpiTempAtual
            kpi_umi.innerHTML = kpiUmiAtual
        } 
    }

    // mudança de cor do card-KPI
    var cardTemperatura = document.getElementById('temperaturaAtual');

    if(kpiTempAtual <= 20){
        cardTemperatura.className = 'kpi atual_abaixo';
    }else if(kpiTempAtual < 25){
        cardTemperatura.className = 'kpi atual_boa';
    }else{
        cardTemperatura.className = 'kpi atual_acima';
    }


    var cardUmidade = document.getElementById('umidadeAtual');

    if(kpiUmiAtual <= 60){
        cardUmidade.className = 'kpi atual_abaixo';
    }else if(kpiUmiAtual <= 80){
        cardUmidade.className = 'kpi atual_boa';
    }else{
        cardUmidade.className = 'kpi atual_acima';
    }
    
   
    const config = {
        type: 'line',
        data: dados,
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'hour',
                        tooltipFormat: 'll HH:mm',
                    },
                },
                y: {
                    beginAtZero: true,
                },
            },
        },
    };


    const graficoTemperaturaUmidade = new Chart(document.getElementById('graficoTemperatura'),config);
}

obterDadosGrafico()


</script>

<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css'>
<script src="https://unpkg.com/feather-icons"></script>

<script>
    feather.replace();
</script>
  
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>


<script data-jsd-embedded data-key="022093e6-0b16-47f0-a2b8-ba3f7236c02f"
    data-base-url="https://jsd-widget.atlassian.com" src="https:jsd-widget.atlassian.com/assets/embed.js"></script>